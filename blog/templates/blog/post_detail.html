<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ post.author }} 블로그</title>
</head>
<body>
    {% include "base.html" %}

    {% csrf_token %}
    
    <div>
        <h1>{{ post.title }}</h1>
        <p>조회수 {{ post.view_count }}</p>
        <p>{{ post.content|linebreaks }}</p>
    </div>

    {% if post.upload_img %}
        <div class="post-image">
            <img src="{{ post.upload_img.url }}" alt="게시글 이미지" class="img-fluid">
        </div>
    {% endif %}

    <div class="like-section"><!-- 좋아요 -->
        <button class="like-btn" 
            data-post-id="{{ post.id }}"
            {% if not user.is_authenticated %}
                data-action="login-required"
            {% elif user == post.author %}
                data-action="own-post"
                disabled
            {% else %}
                data-action="toggle-like"
            {% endif %}
        >
            <img class="like-img" src="/static/images/free-icon-like-symbol-5881205.png" alt="좋아요">
            <span class="like-count">{{ post.like_set.count }}</span>개
        </button>
    </div>

    
    {% if request.user.is_authenticated and request.user == post.author %}
    <div>
        <!-- 수정 버튼 -->
        <a href="{% url 'blog:post_edit' post.pk %}">수정하기</a>

        <!-- 삭제 버튼 -->
        <form action="{% url 'blog:post_delete' post.pk %}" method="post">
            {% csrf_token %}
            <button type="submit">삭제하기</button>
        </form>
    </div>
    {% endif %}



    <hr />
    <!-- 댓글 목록 -->
    <h3>댓글 ({{ comments.count }}개)</h3>
    {% for comment in comments %}
        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
            <strong>{{ comment.author.username }}</strong>
            <small>{{ comment.created_at|date:"Y-m-d H:i" }}</small>
            <p>{{ comment.content|linebreaks }}</p>
        </div>
    {% empty %}
        <p>댓글이 없습니다.</p>
    {% endfor %}

    <!-- 댓글 작성 폼 -->
    {% if user.is_authenticated %}
        <form method="post">
            {% csrf_token %}
            <textarea name="content" placeholder="댓글을 입력하세요" required></textarea><br>
            <button type="submit">댓글 작성</button>
        </form>
    {% else %}
        <p><a href="{% url 'accounts:login' %}">로그인</a>해서 댓글을 작성하세요.</p>
    {% endif %}



    <script>
        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            likeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const action = this.getAttribute('data-action');
                const postId = this.getAttribute('data-post-id');
                
                // 비로그인 사용자
                if (action === 'login-required') {
                    alert('좋아요를 누르려면 로그인이 필요합니다.');
                    // window.location.href = '/accounts/login/';
                    // return;
                }
                
                // 작성자 본인
                if (action === 'own-post') {
                    alert('본인이 작성한 게시글에는 좋아요를 누를 수 없습니다.');
                    // return;
                }
                
                // 정상적인 좋아요 처리
                if (action === 'toggle-like') {
                    fetch(`/blog/${postId}/like/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        
                        const img = document.querySelector('.like-img');
                        const count = document.querySelector('.like-count');
                        
                        if (img && count) {
                            if (data.liked) {
                                img.src = '/static/images/free-icon-like-6924834.png';
                            } else {
                                img.src = '/static/images/free-icon-like-symbol-5881205.png';
                            }
                            count.textContent = data.likes_count;
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>