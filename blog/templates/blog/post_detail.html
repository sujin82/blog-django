{% extends 'base.html' %}

{% block title %} {{ post.author }}의 블로그 {% endblock %}

{% block content %}
    {% csrf_token %}
    
    <div>
        <h1>{{ post.title }}</h1>
        <p>조회수 {{ post.view_count }}</p>
        <p>{{ post.content|linebreaks }}</p>
    </div>

    {% if post.upload_img %}
        <div class="post-image">
            <img src="{{ post.upload_img.url }}" alt="게시글 이미지" class="img-fluid">
        </div>
    {% endif %}

    <div class="like-section"><!-- 좋아요 -->
        <button class="like-btn" 
            data-post-id="{{ post.id }}"
            {% if not user.is_authenticated %}
                data-action="login-required"
            {% elif user == post.author %}
                data-action="own-post"
                disabled
            {% else %}
                data-action="toggle-like"
            {% endif %}
        >
            <img class="like-img" src="/static/images/free-icon-like-symbol-5881205.png" alt="좋아요">
            <span class="like-count">{{ post.like_set.count }}</span>개
        </button>
    </div>

    
    {% if request.user.is_authenticated and request.user == post.author %}
    <div>
        <!-- 수정 버튼 -->
        <a href="{% url 'blog:post_edit' post.pk %}">수정하기</a>

        <!-- 삭제 버튼 -->
        <form action="{% url 'blog:post_delete' post.pk %}" method="post">
            {% csrf_token %}
            <button type="submit">삭제하기</button>
        </form>
    </div>
    {% endif %}

    <hr />

    <!-- 이전/다음 게시글 네비게이션 -->
    <div class="post-navigation">
        <div class="nav-item">
            {% if prev_post %}
                <a href="{% url 'blog:post_detail' prev_post.pk %}">
                    이전글: {{ prev_post.title }}
                </a>
            {% else %}
                <span class="disabled">이전글이 없습니다</span>
            {% endif %}
        </div>

        <div class="nav-item current">
            <span class="current-post">현재글: {{ post.title }}</span>
        </div>
        
        <div class="nav-item">
            {% if next_post %}
                <a href="{% url 'blog:post_detail' next_post.pk %}">
                    다음글: {{ next_post.title }}
                </a>
            {% else %}
                <span class="disabled">다음글이 없습니다</span>
            {% endif %}
        </div>
    </div>


    <hr />
    <!-- 댓글 목록 -->
    <h3>댓글 ({{ comments.count }}개)</h3>
    {% for comment in comments %}
        <div id="comment-{{ comment.id }}">
            <strong>{{ comment.author.username }}</strong>
            <small>{{ comment.created_at|date:"Y-m-d H:i" }}</small>
            <div class="comment-content">
                <span>{{ comment.content|linebreaks }}</span>
            
                {% if comment.author == user %}
                    <button onclick="editComment({{ comment.id }})">수정</button>
                    <button onclick="deleteComment({{ comment.id }})">삭제</button>
                {% endif %}
            </div>
        </div>
    {% empty %}
        <p>댓글이 아직 없습니다.</p>
    {% endfor %}

    <!-- 댓글 작성 폼 -->
    {% if user.is_authenticated %}
        <form method="post">
            {% csrf_token %}
            <textarea name="content" placeholder="댓글을 입력하세요" required></textarea><br>
            <button type="submit">댓글 작성</button>
        </form>
    {% else %}
        <p><a href="{% url 'accounts:login' %}">로그인</a>후 댓글 작성이 가능합니다.</p>
    {% endif %}

    <script>
        // 좋아요
        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            likeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const action = this.getAttribute('data-action');
                const postId = this.getAttribute('data-post-id');
                
                // 비로그인 사용자
                if (action === 'login-required') {
                    alert('좋아요를 누르려면 로그인이 필요합니다.');
                    // window.location.href = '/accounts/login/';
                    // return;
                }
                
                // 작성자 본인
                if (action === 'own-post') {
                    alert('본인이 작성한 게시글에는 좋아요를 누를 수 없습니다.');
                    // return;
                }
                
                // 정상적인 좋아요 처리
                if (action === 'toggle-like') {
                    fetch(`/blog/${postId}/like/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }
                        
                        const img = document.querySelector('.like-img');
                        const count = document.querySelector('.like-count');
                        
                        if (img && count) {
                            if (data.liked) {
                                img.src = '/static/images/free-icon-like-6924834.png';
                            } else {
                                img.src = '/static/images/free-icon-like-symbol-5881205.png';
                            }
                            count.textContent = data.likes_count;
                        }
                    });
                }
            });
        }


        // 댓글 수정&삭제하기
        function editComment(commentId) {   // 수정모드
            const commentDiv = document.getElementById(`comment-${commentId}`);
            const content = commentDiv.querySelector('.comment-content p').textContent.trim();
            
            commentDiv.querySelector('.comment-content').innerHTML = `
                <textarea id="edit-${commentId}">${content}</textarea>
                <button onclick="saveComment(${commentId})">저장</button>
                <button onclick="location.reload()">취소</button>
            `;
        }


        function saveComment(commentId) {
            const content = document.getElementById(`edit-${commentId}`).value;
            
            fetch(`/blog/{{ post.pk }}/comments/edit/`, {
                method: 'POST',
                body: JSON.stringify({
                    comment_id: commentId,
                    content: content
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                console.log('응답 상태:', response.status);  // 디버깅용
                return response.json();
            })
            .then(data => {
                console.log('응답 데이터:', data);  // 디버깅용
                location.reload();
            })
            .catch(error => {
                console.error('에러:', error);  // 디버깅용
            });
        }

        function deleteComment(commentId) {
            if(confirm('댓글을 삭제하시겠습니까?')) {
                fetch(`/blog/{{ post.pk }}/comments/delete/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        comment_id: commentId
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(() => location.reload());
            }
        } 
    </script>
{% endblock %}


